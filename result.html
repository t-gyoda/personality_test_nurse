<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ºæ–­çµæœ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
</head>

<!-- â˜… a.html ã¨åŒã˜èƒŒæ™¯ -->
<body class="bg-[#f5f3ef] text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Tailwind ã®å‹•çš„ã‚¯ãƒ©ã‚¹ç”Ÿæˆå¯¾ç­–ï¼ˆsafelistç”¨ï¼‰ -->
    <div class="hidden bg-amber-400/80 bg-slate-400/80 bg-emerald-400/80 bg-rose-400/80"></div>

    <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
      <h1 class="text-2xl font-bold text-slate-800">è¨ºæ–­çµæœ</h1>
      <a class="text-sm text-slate-500 underline" href="./index.html">ãƒˆãƒƒãƒ—ã¸</a>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="resultBox" class="bg-white/75 rounded-3xl p-5 md:p-8 border border-rose-200/60 shadow-sm">
      <div id="msg" class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒªã‚¢ï¼ˆresultBoxã¨ã¯åˆ¥ï¼šæ¶ˆãˆãªã„ï¼‰ -->
    <div id="mailBox" class="bg-white/75 rounded-3xl border border-rose-200/60 p-5 md:p-6 mt-6 hidden shadow-sm">
      <div class="font-semibold mb-2 text-slate-800">çµæœã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹ï¼ˆä»»æ„ï¼‰</div>
      <input id="email" type="email"
        class="w-full border border-rose-200/70 rounded-2xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-rose-200"
        placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
      <label class="flex items-center gap-2 mt-3 text-sm text-slate-600">
        <input id="consent" type="checkbox" class="h-4 w-4">
        <span>ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«åŒæ„ã—ã¾ã™</span>
      </label>
      <div class="flex items-center gap-2 mt-3">
        <!-- â˜…é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ãƒ”ãƒ³ã‚¯ã« -->
        <button id="sendBtn"
          class="px-5 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition
                 hover:bg-[#e38fac] disabled:opacity-40 disabled:cursor-not-allowed">
          é€ä¿¡
        </button>
        <div id="sendMsg" class="text-sm text-slate-500"></div>
      </div>

      <div class="text-xs text-slate-500 mt-2">
        â€»æœ¬æ©Ÿèƒ½ã¯é€ä¿¡å¸Œæœ›è€…ã®ã¿ã€‚å…¥åŠ›å†…å®¹ã¯ç›®çš„å¤–åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚
      </div>
    </div>

    <!-- ä¸‹éƒ¨ãƒœã‚¿ãƒ³ï¼ˆãƒ”ãƒ³ã‚¯çµ±ä¸€ï¼‰ -->
    <div class="mt-6 flex flex-wrap gap-2">
      <a id="backLink" class="px-4 py-2 rounded-2xl border border-rose-200/70 bg-white/80" href="./index.html">æˆ»ã‚‹</a>
      <a class="px-4 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition hover:bg-[#e38fac]" href="./types.html">
        16ã‚¿ã‚¤ãƒ—ä¸€è¦§ã¸
      </a>
      <a class="px-4 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition hover:bg-[#e38fac]" href="./compat.html">
        ç›¸æ€§è¨ºæ–­ã¸
      </a>
    </div>
  </div>

<script>
  // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function GAS_URL(){
    const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
    if(!u) throw new Error('APP_CONFIG.GAS_URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆconfig.js ã‚’ç¢ºèªï¼‰');
    return u;
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function traitColorClass(title){
    const key = (title || '').trim();
    if(key.includes('è·é›¢')) return 'bg-amber-400/80';
    if(key.includes('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')) return 'bg-slate-400/80';
    if(key.includes('æ¨é€²')) return 'bg-emerald-400/80';
    if(key.includes('æ€è€ƒ')) return 'bg-rose-400/80';
    return 'bg-slate-400/80';
  }

  // â˜…é¸ã°ã‚ŒãŸå´ã®è‰²ï¼ˆãƒãƒ¼è‰²ã«åˆã‚ã›ã‚‹ï¼‰
  function traitTextColorClass(title){
    const key = (title || '').trim();
    if(key.includes('è·é›¢')) return 'text-amber-600';
    if(key.includes('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')) return 'text-slate-600';
    if(key.includes('æ¨é€²')) return 'text-emerald-600';
    if(key.includes('æ€è€ƒ')) return 'text-rose-600';
    return 'text-slate-600';
  }

  function readQuery(){
    const p = new URLSearchParams(location.search);
    return { diagnosisId: p.get('diagnosisId') || '' };
  }

  function loadResultFromSession(){
    const raw = sessionStorage.getItem('LAST_RESULT_JSON');
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  // â˜…æ€§æ ¼ç‰¹æ€§ï¼šï½å‹ã¯ä½¿ã‚ãªã„ï¼è©²å½“èªã‚’å¤ªå­—ãƒ»å¤§ãããƒ»ãƒãƒ¼è‰²ã«åˆã‚ã›ã¦è¡¨ç¤º
  // â˜…ãƒãƒ¼ã¯è©²å½“å´ã‹ã‚‰ä¼¸ã³ã‚‹ï¼ˆå·¦å„ªå‹¢ãªã‚‰å·¦â†’å³ã€å³å„ªå‹¢ãªã‚‰å³â†’å·¦ï¼‰
  function renderTraits(traits){
    if(!Array.isArray(traits) || traits.length === 0){
      return `<div class="text-slate-500 mt-1">ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</div>`;
    }

    return traits.map(t => {
      const pLeft = Math.max(0, Math.min(100, Number(t.percentLeft ?? 50)));
      const isLeft = (pLeft >= 50);
      const chosen = isLeft ? (t.left || '') : (t.right || '');
      const amount = isLeft ? pLeft : (100 - pLeft);

      const barClass = traitColorClass(t.title);
      const textClass = traitTextColorClass(t.title);

      return `
        <div class="rounded-2xl border border-rose-100/80 bg-white/80 p-4">
          <div class="flex items-end justify-between gap-3">
            <div class="text-sm font-medium text-slate-600">${escapeHtml(t.title)}</div>
            <div class="font-extrabold ${textClass} text-xl md:text-2xl leading-none">
              ${escapeHtml(chosen)}
            </div>
          </div>

          <div class="flex justify-between text-xs text-slate-400 mt-2">
            <div>${escapeHtml(t.left)}</div>
            <div>${escapeHtml(t.right)}</div>
          </div>

          <div class="w-full h-3 bg-rose-50 rounded-full mt-3 overflow-hidden">
            <div class="h-3 ${barClass}"
                 style="width:${amount}%; ${isLeft ? 'margin-left:0; margin-right:auto;' : 'margin-left:auto; margin-right:0;'}">
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ===== ãƒ¡ãƒ¼ãƒ«é€ä¿¡ =====
  async function sendEmail(out){
    const emailEl = document.getElementById('email');
    const consentEl = document.getElementById('consent');
    const msgEl = document.getElementById('sendMsg');
    const btnEl = document.getElementById('sendBtn');

    const email = (emailEl?.value || '').trim();
    const consent = !!consentEl?.checked;

    msgEl.textContent = '';

    if(!email){ msgEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    if(!consent){ msgEl.textContent = 'åŒæ„ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„'; return; }

    btnEl.disabled = true;
    msgEl.textContent = 'é€ä¿¡ä¸­â€¦';

    const payload = {
      path: 'sendResultEmail',
      email,
      diagnosisId: out.diagnosisId || '',
      typeCode: out.typeCode || '',
      typeName: out.report?.typeName || out.typeName || '',
      report: out.report || {},
      traits: out.traits || [],
      ts: Date.now()
    };

    let res;
    try{
      res = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });
    } catch (e){
      throw new Error('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/CORS/GAS URLï¼‰');
    }

    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e){}

    if(!res.ok){
      throw new Error('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ' + res.status + 'ï¼‰');
    }

    if(json && json.ok){
      msgEl.textContent = json.message || 'é€ä¿¡ã—ã¾ã—ãŸ';
    } else if (json && json.error){
      throw new Error(json.error);
    } else {
      msgEl.textContent = 'é€ä¿¡ã—ã¾ã—ãŸ';
    }

    btnEl.disabled = false;
  }

  // ===== ãƒ¡ã‚¤ãƒ³æç”» =====
  (function main(){
    const resultBox = document.getElementById('resultBox');
    const msg = document.getElementById('msg');

    try{
      const q = readQuery();
      const out = loadResultFromSession();

      // æˆ»ã‚‹ãƒªãƒ³ã‚¯
      const back = document.getElementById('backLink');
      if(q.diagnosisId === 'A') back.href = './a.html';
      else if(q.diagnosisId === 'B') back.href = './b.html';

      if(!out){
        if(msg) msg.textContent = 'çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¨ºæ–­ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      // ãƒ¡ãƒ¼ãƒ«æ¬„ã¯çµæœãŒã‚ã‚‹ã¨ãã ã‘è¡¨ç¤º
      document.getElementById('mailBox').classList.remove('hidden');

      const typeName = out.report?.typeName || out.typeName || out.typeCode || 'è¨ºæ–­ã‚¿ã‚¤ãƒ—';
      const typeCode = out.typeCode || '';
      const feature = out.report?.feature || '';

      // â˜…é…ç½®ï¼šè¨ºæ–­åï¼ˆå¤§ãƒ»ä¸­å¤®ï¼‰â†’ typeCodeï¼ˆä¸­å¤®ï¼‰â†’ ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆå°‘ã—å°ã•ã‚ï¼‰â†’ feature
      resultBox.innerHTML = `
        <section class="text-center">
          <div class="text-4xl md:text-5xl font-extrabold tracking-tight text-slate-800">
            ${escapeHtml(typeName)}
          </div>
          <div class="mt-2 text-base md:text-lg text-slate-600 font-semibold">
            ${escapeHtml(typeCode)}
          </div>

          <div class="mt-5 flex justify-center">
            <div class="w-full max-w-xs aspect-square rounded-[26px] bg-white/80 border border-rose-200/60 flex items-center justify-center">
              <div class="text-6xl md:text-6xl">ğŸ©º</div>
            </div>
          </div>

          <div class="mt-5 text-slate-700 whitespace-pre-wrap leading-relaxed text-base md:text-lg">
            ${escapeHtml(feature)}
          </div>
        </section>

        <section class="mt-9">
          <div class="font-semibold text-lg text-slate-800 flex items-center justify-center gap-2">
            <span class="text-lg">ğŸ“Š</span>æ€§æ ¼ç‰¹æ€§
          </div>
          <div class="mt-4 grid gap-3 md:grid-cols-2">
            ${renderTraits(out.traits)}
          </div>
        </section>

        <!-- â˜…é–¢é€£ãƒªãƒ³ã‚¯ã¯å‰Šé™¤ã€‚å‚è€ƒãƒªãƒ³ã‚¯ã¯ã€Œ16ã‚¿ã‚¤ãƒ—ä¸€è¦§ã€ã¸ -->
        <section class="mt-9 text-center">
          <div class="text-sm text-slate-600">å‚è€ƒãƒªãƒ³ã‚¯</div>
          <div class="mt-2">
            <a class="inline-block px-4 py-2 rounded-2xl bg-white/80 border border-rose-200/70 underline text-slate-700 hover:bg-white"
               href="./types.html">
              16ã‚¿ã‚¤ãƒ—ä¸€è¦§
            </a>
          </div>
        </section>
      `;

      // é€ä¿¡ãƒœã‚¿ãƒ³
      document.getElementById('sendBtn').onclick = async () => {
        const sendMsg = document.getElementById('sendMsg');
        try{
          await sendEmail(out);
        }catch(e){
          sendMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e);
          console.error(e);
        }
      };

    } catch(e){
      if(msg) msg.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e);
      console.error(e);
    }
  })();
</script>
</body>
</html>
