<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ºæ–­çµæœ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
</head>

<body class="bg-[#f5f3ef] text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Tailwind safelistï¼ˆå‹•çš„ã‚¯ãƒ©ã‚¹å¯¾ç­–ï¼‰ -->
    <div class="hidden
      bg-amber-400/80 bg-slate-400/80 bg-emerald-400/80 bg-rose-400/80
      border-rose-200/60 border-rose-200/70 border-rose-100/80
      border-emerald-200/60 border-emerald-200/70 border-emerald-100/80
      focus:ring-rose-200 focus:ring-emerald-200
      bg-rose-50 bg-emerald-50
      bg-[#eaa5bb] hover:bg-[#e38fac]
      bg-emerald-500 hover:bg-emerald-600
    "></div>

    <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
      <h1 class="text-2xl font-bold text-slate-800">è¨ºæ–­çµæœ</h1>
      <a class="text-sm text-slate-500 underline" href="./index.html">ãƒˆãƒƒãƒ—ã¸</a>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="resultBox" class="bg-white/75 rounded-3xl p-6 md:p-8 border border-rose-200/60 shadow-sm">
      <div id="msg" class="text-slate-600">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆä»»æ„ï¼‰ -->
    <div id="mailBox" class="bg-white/75 rounded-3xl border border-rose-200/60 p-5 md:p-6 mt-6 hidden shadow-sm">
      <div class="font-semibold mb-2 text-slate-800">çµæœã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹ï¼ˆä»»æ„ï¼‰</div>
      <input id="email" type="email"
        class="w-full border border-rose-200/70 rounded-2xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-rose-200"
        placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
      <label class="flex items-center gap-2 mt-3 text-sm text-slate-600">
        <input id="consent" type="checkbox" class="h-4 w-4">
        <span>ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«åŒæ„ã—ã¾ã™</span>
      </label>
      <div class="flex items-center gap-2 mt-3">
        <button id="sendBtn"
          class="px-5 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition
                 hover:bg-[#e38fac] disabled:opacity-40 disabled:cursor-not-allowed">
          é€ä¿¡
        </button>
        <div id="sendMsg" class="text-sm text-slate-500"></div>
      </div>
      <div class="text-xs text-slate-500 mt-2">
        â€»æœ¬æ©Ÿèƒ½ã¯é€ä¿¡å¸Œæœ›è€…ã®ã¿ã€‚å…¥åŠ›å†…å®¹ã¯ç›®çš„å¤–åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚
      </div>
    </div>

    <!-- ä¸‹éƒ¨ãƒœã‚¿ãƒ³ -->
    <div class="mt-6 flex flex-wrap gap-2">
      <a id="backLink" class="px-4 py-2 rounded-2xl border border-rose-200/70 bg-white/80" href="./index.html">æˆ»ã‚‹</a>
      <a id="typesLink" class="px-4 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition hover:bg-[#e38fac]" href="./types.html">
        16ã‚¿ã‚¤ãƒ—ä¸€è¦§ã¸
      </a>
      <a id="compatLink" class="px-4 py-2 rounded-2xl bg-[#eaa5bb] text-white font-semibold transition hover:bg-[#e38fac]" href="./compat.html">
        ç›¸æ€§è¨ºæ–­ã¸
      </a>
    </div>
  </div>

<script id="main">
  // ç”»é¢è¡¨ç¤ºç”¨ï¼ˆå¿…ãš msg ã‚’æ›´æ–°ã™ã‚‹ï¼‰
  function setMsg(text){
    const m = document.getElementById('msg');
    if(m) m.textContent = text;
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function cleanText(s){ return escapeHtml((s || '').trim()); }

  function readQuery(){
    const p = new URLSearchParams(location.search);
    return { diagnosisId: (p.get('diagnosisId') || '').toUpperCase() };
  }
  function loadResultFromSession(){
    const raw = sessionStorage.getItem('LAST_RESULT_JSON');
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  // A=ç®¡ç†è€…ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ / B=çœ‹è­·å¸«ï¼ˆç·‘ï¼‰
  function getTheme(diagnosisId){
    const isB = (diagnosisId === 'B');
    return {
      isB,
      border: isB ? 'border-emerald-200/60' : 'border-rose-200/60',
      border2: isB ? 'border-emerald-200/70' : 'border-rose-200/70',
      borderSoft: isB ? 'border-emerald-100/80' : 'border-rose-100/80',
      ring: isB ? 'focus:ring-emerald-200' : 'focus:ring-rose-200',
      softBg: isB ? 'bg-emerald-50' : 'bg-rose-50',
      primaryBtn: isB ? 'bg-emerald-500 hover:bg-emerald-600' : 'bg-[#eaa5bb] hover:bg-[#e38fac]',
      accentText: isB ? 'text-emerald-700' : 'text-rose-700',
      accentBar: isB ? 'bg-emerald-400/80' : 'bg-rose-400/80'
    };
  }

  function traitColorClass(title, theme){
    const key = (title || '').trim();
    if(key.includes('è·é›¢')) return 'bg-amber-400/80';
    if(key.includes('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')) return 'bg-slate-400/80';
    if(key.includes('æ¨é€²')) return 'bg-emerald-400/80';
    if(key.includes('æ€è€ƒ')) return theme.isB ? 'bg-emerald-400/80' : 'bg-rose-400/80';
    return 'bg-slate-400/80';
  }
  function traitTextColorClass(title, theme){
    const key = (title || '').trim();
    if(key.includes('è·é›¢')) return 'text-amber-700';
    if(key.includes('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')) return 'text-slate-700';
    if(key.includes('æ¨é€²')) return 'text-emerald-700';
    if(key.includes('æ€è€ƒ')) return theme.isB ? 'text-emerald-700' : 'text-rose-700';
    return 'text-slate-700';
  }

  function renderTraits(traits, theme){
    if(!Array.isArray(traits) || traits.length === 0){
      return `<div class="text-slate-500 mt-1">ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</div>`;
    }
    return traits.map(t => {
      const pLeft = Math.max(0, Math.min(100, Number(t.percentLeft ?? 50)));
      const isLeft = (pLeft >= 50);
      const amount = isLeft ? pLeft : (100 - pLeft);

      const barClass = traitColorClass(t.title, theme);
      const hiTextClass = traitTextColorClass(t.title, theme);

      const leftCls = isLeft
        ? `text-xl md:text-2xl font-extrabold ${hiTextClass}`
        : `text-sm md:text-base font-medium text-slate-400`;

      const rightCls = !isLeft
        ? `text-xl md:text-2xl font-extrabold ${hiTextClass}`
        : `text-sm md:text-base font-medium text-slate-400`;

      return `
        <div class="rounded-2xl border ${theme.borderSoft} bg-white/80 p-4">
          <div class="text-sm font-medium text-slate-600">${escapeHtml(t.title)}</div>
          <div class="mt-2 flex items-end justify-between gap-3">
            <div class="${leftCls} leading-none">${escapeHtml(t.left || '')}</div>
            <div class="${rightCls} leading-none">${escapeHtml(t.right || '')}</div>
          </div>
          <div class="w-full h-3 ${theme.softBg} rounded-full mt-3 overflow-hidden">
            <div class="h-3 ${barClass}"
              style="width:${amount}%; ${isLeft ? 'margin-left:0; margin-right:auto;' : 'margin-left:auto; margin-right:0;'}">
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function toHalfWidthDigits(text){
    return String(text || '').replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));
  }

  function normalizeTypeImageId(...candidates){
    for(const raw of candidates){
      if(raw === undefined || raw === null) continue;
      const text = toHalfWidthDigits(raw).trim();
      if(!text) continue;

      const exact = Number(text);
      if(Number.isInteger(exact) && exact >= 1 && exact <= 16){
        return String(exact);
      }

      const m = text.match(/(\d{1,2})/);
      if(!m) continue;
      const n = Number(m[1]);
      if(Number.isInteger(n) && n >= 1 && n <= 16){
        return String(n);
      }
    }
    return '1';
  }

  function normalizeTypeImagePath(...candidates){
    for(const raw of candidates){
      if(raw === undefined || raw === null) continue;
      const text = String(raw).trim();
      if(!text) continue;
      if(/^https?:\/\//i.test(text) || /^\.\/?illustrations\//i.test(text) || /^illustrations\//i.test(text)){
        return text;
      }
    }
    return '';
  }

  function getTypeImageById(...candidates){
    const directPath = normalizeTypeImagePath(...candidates);
    if(directPath) return directPath;

    const imageId = normalizeTypeImageId(...candidates);
    return `./illustrations/${imageId}.png`;
  }

  // class ã®å…¥ã‚Œæ›¿ãˆè£œåŠ©
  function swapClass(el, removeList, addList){
    if(!el) return;
    removeList.forEach(c => el.classList.remove(c));
    addList.forEach(c => el.classList.add(c));
  }

  document.addEventListener('DOMContentLoaded', () => {
    try{
      setMsg('çµæœãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­â€¦');

      const resultBox = document.getElementById('resultBox');
      const mailBox = document.getElementById('mailBox');
      const back = document.getElementById('backLink');
      const sendBtn = document.getElementById('sendBtn');
      const emailInput = document.getElementById('email');
      const typesLink = document.getElementById('typesLink');
      const compatLink = document.getElementById('compatLink');

      const q = readQuery();
      const diagnosisId = (q.diagnosisId || 'A');
      const theme = getTheme(diagnosisId);

      // æˆ»ã‚‹ãƒªãƒ³ã‚¯ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’çµ±ä¸€ï¼‰
      if(diagnosisId === 'A') back.href = './management.html';
      else if(diagnosisId === 'B') back.href = './nurse.html';

      // ãƒ†ãƒ¼ãƒï¼ˆæ ç·š/ãƒœã‚¿ãƒ³è‰²ï¼‰ã‚’A/Bã§åˆ‡æ›¿
      swapClass(resultBox, ['border-rose-200/60','border-emerald-200/60'], [theme.border]);
      swapClass(mailBox,   ['border-rose-200/60','border-emerald-200/60'], [theme.border]);
      swapClass(back,      ['border-rose-200/70','border-emerald-200/70'], [theme.border2]);

      // å…¥åŠ›æ¬„ã®æ ï¼†ãƒªãƒ³ã‚°
      swapClass(emailInput, ['border-rose-200/70','border-emerald-200/70'], [theme.border2]);
      swapClass(emailInput, ['focus:ring-rose-200','focus:ring-emerald-200'], [theme.ring]);

      // é€ä¿¡ãƒœã‚¿ãƒ³
      swapClass(sendBtn, ['bg-[#eaa5bb]','hover:bg-[#e38fac]','bg-emerald-500','hover:bg-emerald-600'], theme.primaryBtn.split(' '));

      // ä¸‹éƒ¨ãƒœã‚¿ãƒ³ï¼ˆä¸€è¦§/ç›¸æ€§ï¼‰
      swapClass(typesLink, ['bg-[#eaa5bb]','hover:bg-[#e38fac]','bg-emerald-500','hover:bg-emerald-600'], theme.primaryBtn.split(' '));
      swapClass(compatLink,['bg-[#eaa5bb]','hover:bg-[#e38fac]','bg-emerald-500','hover:bg-emerald-600'], theme.primaryBtn.split(' '));

      const out = loadResultFromSession();
      if(!out){
        setMsg('çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¨ºæ–­ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚‚ã†ä¸€åº¦ã€Œè¨ºæ–­ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦çµæœç”»é¢ã¸é€²ã‚“ã§ãã ã•ã„ã€‚');
        return;
      }

      // mailæ¬„è¡¨ç¤º
      if(mailBox) mailBox.classList.remove('hidden');

      const r = out.report || {};
      const typeName = r.typeName || out.typeName || out.typeCode || 'è¨ºæ–­ã‚¿ã‚¤ãƒ—';
      const typeCode = r.typeCode || out.typeCode || '';
      const imgSrc = getTypeImageById(
        r.typeImage,
        r.typeImageUrl,
        r.type_image,
        r.type_image_url,
        out.typeImage,
        out.typeImageUrl,
        out.type_image,
        out.type_image_url,
        r.typeID,
        r.typeId,
        r.typeid,
        out.typeID,
        out.typeId,
        out.typeid,
        r.typeNo,
        out.typeNo,
        r.type_no,
        out.type_no,
        typeCode
      );

      const typename2 = r.typename2 || ''; // â˜…è¿½åŠ ï¼štypename2
      const feature  = r.feature || '';
      const strengths = r.strengths || '';
      const cautions  = r.cautions  || '';
      const advice    = r.advice    || '';

      resultBox.innerHTML = `
        <section class="mt-12">
          <!-- typeNameï¼ˆä¸­å¤®ï¼‰ -->
          <div class="text-center">
            <div class="text-4xl md:text-6xl font-extrabold tracking-tight text-slate-800">
              ${escapeHtml(typeName)}
            </div>
          </div>
      
          <!-- â˜…å¤‰æ›´ï¼štypeCodeã¯ã“ã“ã‹ã‚‰æ¶ˆã™ -->
      
          <!-- â˜…å¤‰æ›´ï¼šç”»åƒèƒŒæ™¯ã‚’å®Œå…¨ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã«ï¼ˆãƒ”ãƒ³ã‚¯è¦ç´ ãªã—ï¼‰ -->
          <div class="mt-7 flex justify-center">
            <div class="w-full max-w-sm md:max-w-md aspect-square rounded-[32px] bg-white flex items-center justify-center">
              <img
                src="${imgSrc}"
                alt="${escapeHtml(typeName)} ã®ã‚¤ãƒ©ã‚¹ãƒˆ"
                class="w-full h-full object-contain"
                onerror="this.src='./illustrations/1.png'"
              />
            </div>
          </div>
      
          <!-- â˜…å¤‰æ›´ï¼štypename2 å·¦ã€typeCode ã‚’å³ã«å°ã•ã‚ã§è¡¨ç¤º -->
          <div class="mt-7 mx-auto max-w-2xl flex items-baseline justify-between gap-4">
            <div class="text-lg md:text-xl font-bold text-slate-800 text-left">
              ${cleanText(typename2)}
            </div>
            <div class="text-xs md:text-sm font-medium text-slate-400 whitespace-nowrap">
              ${escapeHtml(typeCode)}
            </div>
          </div>
      
          <!-- â˜…å¤‰æ›´ï¼šfeature å·¦å¯„ã› -->
          <div class="mt-3 mx-auto max-w-2xl text-base md:text-lg font-medium text-slate-700 leading-relaxed text-left">
            ${cleanText(feature)}
          </div>
        </section>
      
        <section class="mt-14">
          <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
            <span class="text-lg">ğŸ“Š</span>æ€§æ ¼ç‰¹æ€§
          </div>
          <div class="mt-4 grid gap-3 md:grid-cols-2">
            ${renderTraits(out.traits, theme)}
          </div>
        </section>
      
        <section class="mt-12 grid gap-6">
          <div class="rounded-2xl bg-white/80 border ${theme.border} p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">âœ¨</span>å¼·ã¿
            </div>
            <div class="mt-3 text-lg md:text-xl text-slate-700 leading-relaxed text-left">
              ${cleanText(strengths)}
            </div>
          </div>
      
          <div class="rounded-2xl bg-white/80 border ${theme.border} p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">ğŸŒ¿</span>æ³¨æ„ç‚¹
            </div>
            <div class="mt-3 text-lg md:text-xl text-slate-700 leading-relaxed text-left">
              ${cleanText(cautions)}
            </div>
          </div>
      
          <div class="rounded-2xl bg-white/80 border ${theme.border} p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">ğŸ’¡</span>ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹
            </div>
            <div class="mt-3 text-lg md:text-xl text-slate-700 leading-relaxed text-left">
              ${cleanText(advice)}
            </div>
          </div>
        </section>
      `;

    }catch(e){
      console.error(e);
      setMsg('ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e));
    }
  });
</script>

</body>
</html>
