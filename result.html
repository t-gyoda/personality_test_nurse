<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ºæ–­çµæœ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
</head>

<body class="bg-[#f6f3ef] text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Tailwind ã®å‹•çš„ã‚¯ãƒ©ã‚¹ç”Ÿæˆå¯¾ç­–ï¼ˆsafelistç”¨ï¼‰ -->
    <div class="hidden bg-amber-400/80 bg-slate-400/80 bg-emerald-400/80 bg-rose-400/80"></div>

    <div class="flex flex-wrap items-center justify-between gap-2 mb-4">
      <h1 class="text-2xl font-bold text-slate-800">è¨ºæ–­çµæœ</h1>
      <a class="text-sm text-slate-500 underline" href="./index.html">ãƒˆãƒƒãƒ—ã¸</a>
    </div>

    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆã“ã“ã ã‘ã‚’æãæ›ãˆã‚‹ï¼‰ -->
    <div id="resultBox" class="bg-[#fdfcf9] rounded-3xl p-5 md:p-8">
      <div id="msg" class="text-gray-600">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒªã‚¢ï¼ˆresultBoxã¨ã¯åˆ¥ã«ã™ã‚‹ï¼šæ¶ˆãˆãªã„ï¼‰ -->
    <div id="mailBox" class="bg-white rounded-3xl border border-slate-200 p-5 md:p-6 mt-6 hidden">
      <div class="font-semibold mb-2 text-slate-800">çµæœã‚’ãƒ¡ãƒ¼ãƒ«ã§å—ã‘å–ã‚‹ï¼ˆä»»æ„ï¼‰</div>
      <input id="email" type="email"
        class="w-full border border-slate-200 rounded-2xl p-3 bg-white focus:outline-none focus:ring-2 focus:ring-slate-200"
        placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
      <label class="flex items-center gap-2 mt-3 text-sm text-slate-600">
        <input id="consent" type="checkbox" class="h-4 w-4">
        <span>ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«åŒæ„ã—ã¾ã™</span>
      </label>
      <div class="flex items-center gap-2 mt-3">
        <button id="sendBtn" class="px-5 py-2 rounded-2xl bg-slate-900 text-white hover:bg-slate-800">é€ä¿¡</button>
        <div id="sendMsg" class="text-sm text-slate-500"></div>
      </div>

      <div class="text-xs text-slate-400 mt-2">
        â€»æœ¬æ©Ÿèƒ½ã¯é€ä¿¡å¸Œæœ›è€…ã®ã¿ã€‚å…¥åŠ›å†…å®¹ã¯ç›®çš„å¤–åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚
      </div>
    </div>

    <div class="mt-6 flex flex-wrap gap-2">
      <a id="backLink" class="px-4 py-2 rounded-2xl border border-slate-200 bg-white" href="./index.html">æˆ»ã‚‹</a>
      <a class="px-4 py-2 rounded-2xl bg-slate-800 text-white" href="./types.html">16ã‚¿ã‚¤ãƒ—ä¸€è¦§ã¸</a>
      <a class="px-4 py-2 rounded-2xl bg-slate-900 text-white" href="./compat.html">ç›¸æ€§è¨ºæ–­ã¸</a>
    </div>
  </div>

<script>
  // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function GAS_URL(){
    const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
    if(!u) throw new Error('APP_CONFIG.GAS_URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆconfig.js ã‚’ç¢ºèªï¼‰');
    return u;
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function traitColorClass(title){
    const key = (title || '').trim();
    if(key.includes('è·é›¢')) return 'bg-amber-400/80';
    if(key.includes('ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³')) return 'bg-slate-400/80';
    if(key.includes('æ¨é€²')) return 'bg-emerald-400/80';
    if(key.includes('æ€è€ƒ')) return 'bg-rose-400/80';
    return 'bg-slate-400/80';
  }

  function readQuery(){
    const p = new URLSearchParams(location.search);
    return { diagnosisId: p.get('diagnosisId') || '' };
  }

  function loadResultFromSession(){
    const raw = sessionStorage.getItem('LAST_RESULT_JSON');
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  function renderTraits(traits){
    if(!Array.isArray(traits) || traits.length === 0){
      return `<div class="text-slate-500 mt-1">ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</div>`;
    }
    return traits.map(t => {
      const p = Math.max(0, Math.min(100, Number(t.percentLeft ?? 50)));
      const barClass = traitColorClass(t.title);
      return `
        <div class="rounded-2xl border border-slate-100 bg-white p-4">
          <div class="flex flex-wrap justify-between gap-2 text-base">
            <div class="font-medium text-slate-700">${escapeHtml(t.title)}</div>
            <div class="text-slate-500">${escapeHtml(t.label || '')}</div>
          </div>
          <div class="flex justify-between text-xs text-slate-400 mt-2">
            <div>${escapeHtml(t.left)}</div>
            <div>${escapeHtml(t.right)}</div>
          </div>
          <div class="w-full h-3 bg-slate-100 rounded-full mt-3 overflow-hidden">
            <div class="h-3 ${barClass}" style="width:${p}%"></div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ===== ãƒ¡ãƒ¼ãƒ«é€ä¿¡ =====
  async function sendEmail(out){
    const emailEl = document.getElementById('email');
    const consentEl = document.getElementById('consent');
    const msgEl = document.getElementById('sendMsg');
    const btnEl = document.getElementById('sendBtn');

    const email = (emailEl?.value || '').trim();
    const consent = !!consentEl?.checked;

    msgEl.textContent = '';

    if(!email){ msgEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
    if(!consent){ msgEl.textContent = 'åŒæ„ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„'; return; }

    btnEl.disabled = true;
    btnEl.classList.add('opacity-60');
    msgEl.textContent = 'é€ä¿¡ä¸­â€¦';

    const payload = {
      path: 'sendResultEmail',
      email,
      diagnosisId: out.diagnosisId || '',
      typeCode: out.typeCode || '',
      typeName: out.report?.typeName || out.typeName || '',
      report: out.report || {},
      traits: out.traits || [],
      ts: Date.now()
    };

    let res;
    try{
      res = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });
    } catch (e){
      throw new Error('é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/CORS/GAS URLï¼‰');
    }

    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e){ /* textã®ã¾ã¾ */ }

    if(!res.ok){
      throw new Error('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ' + res.status + 'ï¼‰');
    }

    // GASãŒ {ok:true,message:""} ã‚’è¿”ã™æƒ³å®šã€‚é•ã£ã¦ã‚‚è¡¨ç¤ºã¯å´©ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
    if(json && json.ok){
      msgEl.textContent = json.message || 'é€ä¿¡ã—ã¾ã—ãŸ';
    } else if (json && json.error){
      throw new Error(json.error);
    } else {
      // textå¿œç­”ã§ã‚‚ä¸€å¿œã€ŒæˆåŠŸã€æ‰±ã„ã«ã™ã‚‹ï¼ˆGASå´ä»•æ§˜ãŒé•ã†å ´åˆï¼‰
      msgEl.textContent = 'é€ä¿¡ã—ã¾ã—ãŸ';
    }

    btnEl.disabled = false;
    btnEl.classList.remove('opacity-60');
  }

  // ===== ãƒ¡ã‚¤ãƒ³æç”» =====
  (function main(){
    const resultBox = document.getElementById('resultBox');
    const msg = document.getElementById('msg');

    try{
      const q = readQuery();
      const out = loadResultFromSession();

      // æˆ»ã‚‹ãƒªãƒ³ã‚¯ï¼ˆè¨ºæ–­A/Bã«æˆ»ã™ï¼‰
      const back = document.getElementById('backLink');
      if(q.diagnosisId === 'A') back.href = './a.html';
      else if(q.diagnosisId === 'B') back.href = './b.html';

      if(!out){
        if(msg) msg.textContent = 'çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚è¨ºæ–­ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      // ãƒ¡ãƒ¼ãƒ«æ¬„ã¯çµæœãŒã‚ã‚‹ã¨ãã ã‘è¡¨ç¤º
      document.getElementById('mailBox').classList.remove('hidden');

      const links = (out.report?.links || [])
        .map(l => `<li><a class="underline" href="${escapeHtml(l.url)}" target="_blank" rel="noreferrer">${escapeHtml(l.label)}</a></li>`)
        .join('');

      const typeName = out.report?.typeName || out.typeName || out.typeCode || 'è¨ºæ–­ã‚¿ã‚¤ãƒ—';
      const typeCode = out.typeCode || '';

      resultBox.innerHTML = `
        <div class="text-xs text-slate-400">è¨ºæ–­ ${escapeHtml(out.diagnosisId || q.diagnosisId)}</div>

        <section class="mt-4 grid gap-5 md:grid-cols-[1.05fr_0.95fr] items-start">
          <div>
            <div class="text-left">
              <div class="text-3xl md:text-4xl font-bold tracking-wide text-slate-800">${escapeHtml(typeName)}</div>
              <div class="mt-1 text-sm md:text-base text-slate-500 font-medium">${escapeHtml(typeCode)}</div>
            </div>
            <div class="mt-4 text-slate-600 whitespace-pre-wrap leading-relaxed">${escapeHtml(out.report?.feature || '')}</div>
          </div>

          <div class="flex flex-col items-center gap-3">
            <div class="w-full aspect-square max-w-sm rounded-[28px] bg-[#f5f2ee] border border-slate-200 flex items-center justify-center">
              <div class="text-6xl md:text-7xl">ğŸ©º</div>
            </div>
            <div class="text-center text-xs text-slate-500">
              ã‚ãªãŸã‚‰ã—ã•ã‚’æ˜ ã—ãŸãƒŠãƒ¼ã‚¹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
            </div>
          </div>
        </section>

        <section class="mt-8">
          <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
            <span class="text-lg">ğŸ“Š</span>æ€§æ ¼ç‰¹æ€§
          </div>
          <div class="mt-3 grid gap-3 md:grid-cols-2">${renderTraits(out.traits)}</div>
        </section>

        <section class="mt-8 grid gap-5">
          <div class="rounded-2xl bg-[#f6f2eb] border border-slate-200 p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">âœ¨</span>å¼·ã¿
            </div>
            <div class="text-slate-600 text-base whitespace-pre-wrap mt-2 leading-relaxed">${escapeHtml(out.report?.strengths || '')}</div>
          </div>

          <div class="rounded-2xl bg-[#f1f5f4] border border-slate-200 p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">ğŸŒ¿</span>æ³¨æ„ç‚¹
            </div>
            <div class="text-slate-600 text-base whitespace-pre-wrap mt-2 leading-relaxed">${escapeHtml(out.report?.cautions || '')}</div>
          </div>

          <div class="rounded-2xl bg-[#f5f1f3] border border-slate-200 p-5">
            <div class="font-semibold text-lg text-slate-800 flex items-center gap-2">
              <span class="text-lg">ğŸ’¡</span>ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹
            </div>
            <div class="text-slate-600 text-base whitespace-pre-wrap mt-2 leading-relaxed">${escapeHtml(out.report?.advice || '')}</div>
          </div>
        </section>

        <section class="mt-8">
          <div class="font-semibold text-slate-800 flex items-center gap-2">
            <span class="text-lg">ğŸ”—</span>é–¢é€£ãƒªãƒ³ã‚¯
          </div>
          ${links ? `<ul class="list-disc pl-5 mt-2 text-slate-600">${links}</ul>` : `<div class="text-slate-500 mt-2">ï¼ˆæœªè¨­å®šï¼‰</div>`}
        </section>
      `;

      // é€ä¿¡ãƒœã‚¿ãƒ³
      document.getElementById('sendBtn').onclick = async () => {
        const sendMsg = document.getElementById('sendMsg');
        try{
          await sendEmail(out);
        }catch(e){
          sendMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e);
          console.error(e);
        }
      };

    } catch(e){
      if(msg) msg.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + (e?.message || e);
      console.error(e);
    }
  })();
</script>
</body>
</html>
