<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>診断結果</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
</head>

<body class="bg-gray-50">
  <div class="max-w-3xl mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">診断結果だよ</h1>
      <a class="text-sm underline" href="./index.html">トップへ</a>
    </div>

    <!-- 結果表示エリア（ここだけを描き換える） -->
    <div id="resultBox" class="bg-white rounded-2xl shadow p-5">
      <div id="msg" class="text-gray-600">読み込み中…</div>
    </div>

    <!-- メール送信エリア（resultBoxとは別にする：消えない） -->
    <div id="mailBox" class="bg-white rounded-2xl shadow p-5 mt-4 hidden">
      <div class="font-semibold mb-2">結果をメールで受け取る（任意）</div>
      <input id="email" type="email" class="w-full border rounded-xl p-3" placeholder="メールアドレス" />
      <label class="flex items-center gap-2 mt-3 text-sm">
        <input id="consent" type="checkbox" class="h-4 w-4">
        <span>メール送信に同意します</span>
      </label>
      <div class="flex items-center gap-2 mt-3">
        <button id="sendBtn" class="px-4 py-2 rounded-xl bg-black text-white">送信</button>
        <div id="sendMsg" class="text-sm text-gray-600"></div>
      </div>
      <div class="text-xs text-gray-400 mt-2">
        ※本機能は送信希望者のみ。入力内容は目的外利用しません。
      </div>
    </div>

    <div class="mt-4 flex gap-2">
      <a id="backLink" class="px-4 py-2 rounded-xl border" href="./index.html">戻る</a>
      <a class="px-4 py-2 rounded-xl bg-gray-800 text-white" href="./types.html">16タイプ一覧へ</a>
      <a class="px-4 py-2 rounded-xl bg-black text-white" href="./compat.html">相性診断へ</a>
    </div>
  </div>

<script>
  function GAS_URL(){
    const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
    if(!u) throw new Error('APP_CONFIG.GAS_URL が見つかりません（config.js を確認）');
    return u;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function readQuery(){
    const p = new URLSearchParams(location.search);
    return { diagnosisId: p.get('diagnosisId') || '' };
  }

  function loadResultFromSession(){
    const raw = sessionStorage.getItem('LAST_RESULT_JSON');
    if(!raw) return null;
    try { return JSON.parse(raw); } catch(e){ return null; }
  }

  async function sendEmail(out){
    const email = document.getElementById('email').value.trim();
    const consent = document.getElementById('consent').checked;
    const msg = document.getElementById('sendMsg');
    msg.textContent = '';

    if(!email){ msg.textContent = 'メールアドレスを入力してください'; return; }
    if(!consent){ msg.textContent = '同意にチェックしてください'; return; }

    msg.textContent = '送信中…';

    const payload = {
      path: 'sendResultEmail',
      email,
      diagnosisId: out.diagnosisId || '',
      typeCode: out.typeCode,
      axisScores: out.axisScores || {},
      report: out.report || {}
    };

    const r = await fetch(GAS_URL(), {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });

    const j = await r.json();
    if(!j.ok) throw new Error(j.error || '送信に失敗しました');

    msg.textContent = '送信しました';
  }

  (function main(){
    const q = readQuery();
    const out = loadResultFromSession();

    // 戻るリンク（診断A/Bに戻す）
    const back = document.getElementById('backLink');
    if(q.diagnosisId === 'A') back.href = './a.html';
    else if(q.diagnosisId === 'B') back.href = './b.html';

    const resultBox = document.getElementById('resultBox');
    const msg = document.getElementById('msg');

    if(!out){
      msg.textContent = '結果データが見つかりませんでした。診断ページからもう一度実行してください。';
      return;
    }

    // メール欄は結果があるときだけ表示
    document.getElementById('mailBox').classList.remove('hidden');

    const links = (out.report?.links || [])
      .map(l => `<li><a class="underline" href="${escapeHtml(l.url)}" target="_blank" rel="noreferrer">${escapeHtml(l.label)}</a></li>`)
      .join('');

    resultBox.innerHTML = `
       <div class="text-sm text-gray-500">診断 ${escapeHtml(out.diagnosisId || q.diagnosisId)}</div>
        <div class="text-2xl font-bold mt-1">${escapeHtml(out.typeCode)} ${out.report?.typeName ? `（${escapeHtml(out.report.typeName)}）` : ''}</div>
      
        <div class="mt-4">
          <div class="font-semibold">特徴</div>
          <div class="text-gray-700 whitespace-pre-wrap mt-1">${escapeHtml(out.report?.feature || '')}</div>
        </div>
      
        <div class="mt-4">
          <div class="font-semibold">性格特性</div>
          <div class="mt-1">${renderTraits(out.traits)}</div>
        </div>
      
        <div class="mt-4">
          <div class="font-semibold">強み</div>
          <div class="text-gray-700 whitespace-pre-wrap mt-1">${escapeHtml(out.report?.strengths || '')}</div>
        </div>
      
      <div class="mt-4">
        <div class="font-semibold">注意点</div>
        <div class="text-gray-700 whitespace-pre-wrap mt-1">${escapeHtml(out.report?.cautions || '')}</div>
      </div>

      <div class="mt-4">
        <div class="font-semibold">ワンポイントアドバイス</div>
        <div class="text-gray-700 whitespace-pre-wrap mt-1">${escapeHtml(out.report?.advice || '')}</div>
      </div>

      <div class="mt-4">
        <div class="font-semibold">関連リンク</div>
        ${links ? `<ul class="list-disc pl-5 mt-1">${links}</ul>` : `<div class="text-gray-500 mt-1">（未設定）</div>`}
      </div>
    `;

    // 送信ボタンのイベント紐付け（resultBoxを書き換えても mailBox は別なので消えない）
    document.getElementById('sendBtn').onclick = async () => {
      try{
        await sendEmail(out);
      }catch(e){
        document.getElementById('sendMsg').textContent = 'エラー：' + e.message;
      }
    };
  })();
  function renderTraits(traits){
    if(!Array.isArray(traits) || traits.length === 0){
      return `<div class="text-gray-500 mt-1">（データなし）</div>`;
    }
    return traits.map(t => {
      const p = Math.max(0, Math.min(100, Number(t.percentLeft ?? 50)));
      return `
        <div class="mt-3">
          <div class="flex justify-between text-sm">
            <div class="font-medium">${escapeHtml(t.title)}</div>
            <div class="text-gray-600">${escapeHtml(t.label || '')}</div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <div>${escapeHtml(t.left)}</div>
            <div>${escapeHtml(t.right)}</div>
          </div>
          <div class="w-full h-3 bg-gray-200 rounded-full mt-2 overflow-hidden">
            <div class="h-3 bg-gray-800" style="width:${p}%"></div>
          </div>
        </div>
      `;
    }).join('');
  }
</script>
</body>
</html>
