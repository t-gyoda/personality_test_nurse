<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>診断N｜看護師向け16タイプ診断</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="./config.js"></script>
</head>

<body class="bg-[#f2f6f3] text-slate-800 min-h-screen">
  <!-- version 表記 -->
  <div class="max-w-3xl mx-auto px-6 pt-3">
    <div class="text-xs text-gray-400">nurse.html version: 2026-01-29-1</div>
  </div>

  <div class="relative">
    <div class="max-w-3xl mx-auto p-6">

      <!-- トップバー -->
      <div class="mb-5">
        <div class="flex items-center justify-end text-sm text-slate-500">
          <a href="./index.html" class="font-semibold hover:text-slate-700">
            トップへ
          </a>
        </div>
      </div>

      <!-- 進捗 -->
      <div id="progressWrap"
           class="sticky top-0 z-20 -mx-6 px-6 pt-3 pb-3
                  bg-[#f2f6f3]/90 backdrop-blur border-b border-emerald-100">
        <div class="flex items-center justify-between">
          <div class="h-2 w-full rounded-full bg-emerald-100/80 overflow-hidden">
            <div id="progressBar"
                 class="h-2 rounded-full bg-emerald-400"
                 style="width:0%"></div>
          </div>
          <div id="progressText"
               class="ml-3 shrink-0 text-sm font-semibold text-slate-700 tabular-nums">
            0 / 0
          </div>
        </div>
      </div>

      <!-- タイトル -->
      <div class="mt-6 mb-7">
        <div class="rounded-3xl border border-emerald-200/70 bg-white/80 shadow-sm px-6 py-7">
          <h1 class="text-center leading-tight font-extrabold tracking-tight text-slate-800">
            <div class="text-4xl sm:text-5xl">
              看護師タイプ診断
            </div>
            <div class="mt-2 text-2xl sm:text-3xl">
              ～日々の現場スタイルを見える化～
            </div>
          </h1>

          <p class="text-base sm:text-lg text-slate-600 mt-5 text-center">
            あなたの働き方の傾向を、やさしく整理します。
          </p>

          <div class="mt-5 flex justify-center">
            <div class="h-2 w-24 rounded-full
                        bg-gradient-to-r from-emerald-200 via-green-200 to-emerald-100"></div>
          </div>
        </div>
      </div>

      <div id="loading" class="text-slate-600">質問を読み込んでいます…</div>
      <form id="form" class="hidden space-y-6"></form>

      <div class="mt-8">
        <button id="submitBtn"
          class="hidden w-full px-4 py-4 rounded-2xl
                 bg-emerald-500 text-white
                 text-lg font-semibold shadow-sm transition
                 hover:bg-emerald-600
                 disabled:opacity-40 disabled:cursor-not-allowed
                 disabled:hover:bg-emerald-500">
          診断する
        </button>
        <p class="mt-3 text-center text-xs text-slate-500">
          診断結果はすぐに表示されます。
        </p>
      </div>

    </div>
  </div>

  <script>
    function GAS_URL(){
      const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
      if(!u) throw new Error('APP_CONFIG.GAS_URL が見つかりません');
      return u;
    }

    function sid(){
      const k = 'diag_sid';
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
        localStorage.setItem(k, v);
      }
      return v;
    }

    async function loadQuestions(){
      const url = `${GAS_URL()}?path=questions&diagnosisId=B`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || '質問取得に失敗しました');
      return j.questions;
    }

    function setSubmitEnabled(questions){
      const form = document.getElementById('form');
      const btn = document.getElementById('submitBtn');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      btn.disabled = !(total > 0 && answered === total);
    }

    function updateProgress(questions){
      const form = document.getElementById('form');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const ratio = total ? Math.round((answered / total) * 100) : 0;

      document.getElementById('progressText').textContent = `${answered} / ${total}`;
      document.getElementById('progressBar').style.width = `${ratio}%`;

      setSubmitEnabled(questions);
    }

    function renderQuestions(questions){
      const form = document.getElementById('form');
      form.innerHTML = '';
      updateProgress(questions);

      questions.forEach(q => {
        const box = document.createElement('div');
        box.className = 'py-6 border-b border-emerald-100/80';

        const title = document.createElement('div');
        title.className =
          'font-semibold mb-4 text-slate-800 text-xl sm:text-2xl text-center';
        title.textContent = `Q${q.order}. ${q.questionText}`;

        const choices = document.createElement('div');
        choices.className = 'flex gap-3 flex-col sm:flex-row';

        (q.choices || []).forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c.text;

          btn.className =
            'flex-1 px-4 py-3 rounded-2xl border border-emerald-200/80 bg-white/80 ' +
            'text-center whitespace-normal leading-relaxed text-base sm:text-lg text-slate-800 shadow-sm ' +
            'hover:border-emerald-300 hover:bg-emerald-50 transition';

          btn.onclick = () => {
            [...choices.children].forEach(b => {
              b.classList.remove('bg-emerald-500','text-white','border-transparent','shadow-md');
              b.classList.add('bg-white/80','text-slate-800');
            });

            btn.classList.remove('bg-white/80','text-slate-800');
            btn.classList.add('bg-emerald-500','text-white','border-transparent','shadow-md');

            form.dataset[q.qId] = idx;
            updateProgress(questions);
          };

          choices.appendChild(btn);
        });

        box.appendChild(title);
        box.appendChild(choices);
        form.appendChild(box);
      });
    }

    async function submitAnswers(questions){
      const form = document.getElementById('form');
      const answers = {};

      for(const q of questions){
        const v = form.dataset[q.qId];
        if(v === undefined){
          alert(`未回答の質問があります（Q${q.order}）`);
          return;
        }
        answers[q.qId] = Number(v);
      }

      const payload = {
        path: 'submit',
        diagnosisId: 'B',
        sessionId: sid(),
        answers,
        email: '',
        ua: navigator.userAgent
      };

      const r = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const j = await r.json();
      if(!j.ok) throw new Error(j.error || '診断に失敗しました');

      sessionStorage.setItem('LAST_RESULT_JSON', JSON.stringify(j));
      location.href = './result.html?diagnosisId=B';
    }

    (async function main(){
      try{
        const questions = await loadQuestions();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('form').classList.remove('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');

        renderQuestions(questions);

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        setSubmitEnabled(questions);

        submitBtn.onclick = async () => {
          if(submitBtn.disabled) return;
          submitBtn.textContent = '診断中…';
          submitBtn.disabled = true;
          await submitAnswers(questions);
        };

      }catch(e){
        document.getElementById('loading').textContent = 'エラー：' + e.message;
      }
    })();
  </script>
</body>
</html>
