<div class="text-xs text-gray-400">a.html version: 2026-01-28-1</div>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ºæ–­Aï½œçœ‹è­·å¸«ç®¡ç†è€…å‘ã‘16ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- â˜…å¿…ãš head å†…ã§ config.js ã‚’èª­ã¿è¾¼ã‚€ -->
  <script src="./config.js"></script>
</head>

<body class="bg-[#f6e9ee] text-slate-800 min-h-screen">
  <div class="relative">
    <div class="max-w-3xl mx-auto p-6">

      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <div class="mb-5">
        <div class="flex items-center justify-between text-sm text-slate-500">
          <div class="inline-flex items-center gap-2 rounded-full bg-white/70 px-3 py-1 font-semibold text-slate-700 shadow-sm border border-rose-100">
            <span>ğŸŒ·</span>
            <span>çœ‹è­·å¸«ã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
          </div>
          <a href="./index.html" class="font-semibold text-slate-500 hover:text-slate-700">ãƒˆãƒƒãƒ—ã¸</a>
        </div>
      </div>

      <!-- é€²æ—ï¼ˆå›ºå®šè¡¨ç¤ºï¼šèª¬æ˜æ–‡ãªã— / ãƒãƒ¼ + 0/20ã®ã¿ï¼‰ -->
      <div id="progressWrap" class="sticky top-0 z-20 -mx-6 px-6 pt-3 pb-3 bg-[#f6e9ee]/90 backdrop-blur border-b border-rose-100">
        <div class="flex items-center justify-between">
          <div class="h-2 w-full rounded-full bg-rose-100/80 overflow-hidden">
            <div id="progressBar" class="h-2 rounded-full bg-[#e7a9bc]" style="width:0%"></div>
          </div>
          <div id="progressText" class="ml-3 shrink-0 text-sm font-semibold text-slate-700 tabular-nums">0 / 0</div>
        </div>
      </div>

      <!-- ã‚¿ã‚¤ãƒˆãƒ«ï¼‹èª¬æ˜ï¼ˆæ ã§å›²ã„ã€ã‹ã‚ã„ã•ï¼‹è½ã¡ç€ãï¼‰ -->
      <div class="mt-6 mb-7">
        <div class="rounded-3xl border border-rose-200/70 bg-white/70 shadow-sm px-6 py-6">
          <div class="absolute opacity-0 pointer-events-none select-none">.</div>
          <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-center text-slate-800 leading-tight">
            çœ‹è­·å¸«ã‚¿ã‚¤ãƒ—è¨ºæ–­<br class="hidden sm:block" />
            <span class="sm:hidden"> </span>
            <span class="text-rose-500">ç—…é™¢ã‚’æ”¯ãˆã‚‹ç®¡ç†è·å‘ã‘</span>
          </h1>

          <!-- ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜æ–‡ã®é–“éš”ã‚’ã—ã£ã‹ã‚Š -->
          <p class="text-base sm:text-lg text-slate-600 mt-4 text-center">
            ã‚ãªãŸã®ç¾å ´ã¨ã®ã‹ã‹ã‚ã‚Šæ–¹ã‚’è¦‹ãˆã‚‹åŒ–ã€‚
          </p>

          <!-- ã»ã‚“ã®ã‚Šæ¥½ã—ã„è£…é£¾ -->
          <div class="mt-5 flex justify-center">
            <div class="h-2 w-24 rounded-full bg-gradient-to-r from-rose-200 via-pink-200 to-rose-100"></div>
          </div>
        </div>
      </div>

      <div id="loading" class="text-slate-600">è³ªå•ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</div>

      <form id="form" class="hidden space-y-6"></form>

      <div class="mt-8">
        <button id="submitBtn"
          class="hidden w-full px-4 py-4 rounded-2xl bg-[#eaa5bb] text-white text-lg font-semibold shadow-sm transition
                 hover:bg-[#e38fac] disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-[#eaa5bb]">
          è¨ºæ–­ã™ã‚‹
        </button>
        <p class="mt-3 text-center text-xs text-slate-500">è¨ºæ–­çµæœã¯ã™ãã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <script>
    function GAS_URL(){
      const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
      if(!u) throw new Error('APP_CONFIG.GAS_URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆconfig.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      return u;
    }

    function sid(){
      const k = 'diag_sid';
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
        localStorage.setItem(k, v);
      }
      return v;
    }

    async function loadQuestions(){
      const url = `${GAS_URL()}?path=questions&diagnosisId=A`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'è³ªå•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return j.questions;
    }

    function setSubmitEnabled(questions){
      const form = document.getElementById('form');
      const btn = document.getElementById('submitBtn');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const allAnswered = (total > 0 && answered === total);

      btn.disabled = !allAnswered;
      // ã€Œå…¨å›ç­”ã¾ã§è–„ã„ã€ï¼‹ hoverã‚‚æŠ‘åˆ¶ï¼ˆdisabledã‚¯ãƒ©ã‚¹ã§å¯¾å¿œæ¸ˆã¿ï¼‰
    }

    function updateProgress(questions){
      const form = document.getElementById('form');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const ratio = total ? Math.round((answered / total) * 100) : 0;

      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');

      if(progressText) progressText.textContent = `${answered} / ${total}`;
      if(progressBar) progressBar.style.width = `${ratio}%`;

      setSubmitEnabled(questions);
    }

    function renderQuestions(questions){
      const form = document.getElementById('form');
      form.innerHTML = '';
      updateProgress(questions);

      questions.forEach(q => {
        const box = document.createElement('div');
        box.className = 'py-6 border-b border-rose-100/80';

        const title = document.createElement('div');
        // è³ªå•ï¼šå°‘ã—å¤§ããï¼‹ä¸­å¤®ã‚ˆã‚Š
        title.className = 'font-semibold mb-4 text-slate-800 text-xl sm:text-2xl text-center';
        title.textContent = `Q${q.order}. ${q.questionText}`;

        const choices = document.createElement('div');
        choices.className = 'flex gap-3 flex-col sm:flex-row';

        (q.choices || []).forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c.text;

          // å›ç­”ãƒœã‚¿ãƒ³ï¼šãƒ”ãƒ³ã‚¯ç³»ã€æ–‡å­—ã¯ä¸­å¤®å¯„ã‚Šï¼†å°‘ã—å¤§ãã
          btn.className =
            'flex-1 px-4 py-3 rounded-2xl border border-rose-200/80 bg-white/80 ' +
            'text-center whitespace-normal leading-relaxed text-base sm:text-lg text-slate-800 shadow-sm ' +
            'hover:border-rose-300 hover:bg-rose-50 transition';

          btn.onclick = () => {
            [...choices.children].forEach(b => {
              b.classList.remove('bg-[#e38fac]','text-white','border-transparent','shadow-md');
              b.classList.add('bg-white/80','text-slate-800');
            });

            btn.classList.remove('bg-white/80','text-slate-800');
            btn.classList.add('bg-[#e38fac]','text-white','border-transparent','shadow-md');

            form.dataset[q.qId] = idx; // 0 or 1
            updateProgress(questions);
          };

          choices.appendChild(btn);
        });

        box.appendChild(title);
        box.appendChild(choices);
        form.appendChild(box);
      });
    }

    async function submitAnswers(questions){
      const form = document.getElementById('form');
      const answers = {};

      for(const q of questions){
        const v = form.dataset[q.qId];
        if(v === undefined){
          alert(`æœªå›ç­”ã®è³ªå•ãŒã‚ã‚Šã¾ã™ï¼ˆQ${q.order}ï¼‰`);
          throw new Error('æœªå›ç­”');
        }
        answers[q.qId] = Number(v);
      }

      const payload = {
        path: 'submit',
        diagnosisId: 'A',
        sessionId: sid(),
        answers,
        email: '',
        ua: navigator.userAgent
      };

      const r = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ');

      sessionStorage.setItem('LAST_RESULT_JSON', JSON.stringify(j));
      location.href = './result.html?diagnosisId=A';
    }

    (async function main(){
      try{
        const questions = await loadQuestions();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('form').classList.remove('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');

        renderQuestions(questions);

        const submitBtn = document.getElementById('submitBtn');
        // åˆæœŸã¯è–„ã„ï¼ˆdisabledï¼‰ã«ã—ãŸã„ã®ã§ã€ã“ã“ã§å¿…ãšåæ˜ 
        submitBtn.disabled = true;
        setSubmitEnabled(questions);

        submitBtn.onclick = async () => {
          if(submitBtn.disabled) return; // å…¨å›ç­”å‰ã¯æŠ¼ã›ãªã„
          submitBtn.textContent = 'è¨ºæ–­ä¸­â€¦';
          submitBtn.disabled = true;
          await submitAnswers(questions);
        };

      }catch(e){
        document.getElementById('loading').textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + e.message;
      }
    })();
  </script>
</body>
</html>
