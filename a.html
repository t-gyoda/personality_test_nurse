<div class="text-xs text-gray-400">a.html version: 2025-12-31-1</div>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨ºæ–­Aï½œçœ‹è­·å¸«ç®¡ç†è€…å‘ã‘16ãƒ‘ãƒ¼ã‚½ãƒŠãƒªãƒ†ã‚£</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- â˜…å¿…ãš head å†…ã§ config.js ã‚’èª­ã¿è¾¼ã‚€ -->
  <script src="./config.js"></script>
</head>

<body class="bg-gradient-to-br from-pink-50 via-purple-50 to-sky-50 text-gray-800 min-h-screen">
  <div class="relative overflow-hidden">
    <div class="pointer-events-none absolute -top-16 -left-10 h-40 w-40 rounded-full bg-pink-200/60 blur-2xl"></div>
    <div class="pointer-events-none absolute top-32 -right-10 h-48 w-48 rounded-full bg-purple-200/60 blur-2xl"></div>
    <div class="max-w-3xl mx-auto p-6 relative">
      <div class="flex items-center justify-between mb-6">
        <div>
          <div class="inline-flex items-center gap-2 rounded-full bg-white/70 px-3 py-1 text-xs font-semibold text-pink-600 shadow-sm">
            <span>ğŸ’–</span>
            <span>çœ‹è­·å¸«ã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
          </div>
          <h1 class="text-3xl font-extrabold tracking-tight mt-3"> çœ‹è­·å¸«ã‚¿ã‚¤ãƒ—è¨ºæ–­ ~ç—…é™¢ã‚’æ”¯ãˆã‚‹ç®¡ç†è·å‘ã‘~ </h1>
          <p class="text-1xl text-gray-500 mt-1">ã‚ãªãŸã®ç¾å ´ã¨ã®ã‹ã‹ã‚ã‚Šæ–¹ã‚’è¦‹ãˆã‚‹åŒ–ã€‚</p>
        </div>
        <a href="./index.html" class="text-sm font-semibold text-pink-500 hover:text-pink-600">ãƒˆãƒƒãƒ—ã¸</a>
      </div>

      <div class="mb-6 rounded-3xl bg-white/80 p-5 shadow-md border border-white">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-500">é€²æ—</div>
          <div id="progressText" class="text-sm font-semibold text-purple-600">0 / 0</div>
        </div>
        <div class="mt-2 h-2 w-full rounded-full bg-purple-100">
          <div id="progressBar" class="h-2 rounded-full bg-gradient-to-r from-pink-400 to-purple-400" style="width:0%"></div>
        </div>
        <p class="mt-3 text-xs text-gray-500">ç›´æ„Ÿã§ã‚µã‚¯ã‚µã‚¯ç­”ãˆã¦OKï¼</p>
      </div>

      <div id="loading" class="text-gray-600">è³ªå•ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</div>

      <form id="form" class="hidden space-y-6"></form>

      <div class="mt-8">
        <button id="submitBtn"
          class="hidden w-full px-4 py-4 rounded-2xl bg-gradient-to-r from-pink-500 to-purple-500 text-white text-lg font-semibold shadow-lg hover:shadow-xl transition">
          è¨ºæ–­ã™ã‚‹
        </button>
        <p class="mt-3 text-center text-xs text-gray-400">è¨ºæ–­çµæœã¯ã™ãã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
      </div>
    </div>
  </div>

  <!-- â˜…JavaScript ã¯å¿…ãš script ã‚¿ã‚°å†…ã«å…¥ã‚Œã‚‹ -->
  <script>
    function GAS_URL(){
      const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
      if(!u) throw new Error('APP_CONFIG.GAS_URL ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆconfig.js ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
      return u;
    }

    function sid(){
      const k = 'diag_sid';
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
        localStorage.setItem(k, v);
      }
      return v;
    }

    async function loadQuestions(){
      const url = `${GAS_URL()}?path=questions&diagnosisId=A`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'è³ªå•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      return j.questions;
    }

    function updateProgress(questions){
      const form = document.getElementById('form');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const ratio = total ? Math.round((answered / total) * 100) : 0;
      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');
      if(progressText) progressText.textContent = `${answered} / ${total}`;
      if(progressBar) progressBar.style.width = `${ratio}%`;
    }

    function renderQuestions(questions){
      const form = document.getElementById('form');
      form.innerHTML = '';
      updateProgress(questions);

      questions.forEach(q => {
        const box = document.createElement('div');
        box.className = 'bg-white/90 rounded-3xl shadow-md p-6 border border-white';

        const title = document.createElement('div');
        title.className = 'font-semibold mb-4 text-gray-700';
        title.textContent = `Q${q.order}. ${q.questionText}`;

        const choices = document.createElement('div');
        choices.className = 'flex gap-3 flex-col sm:flex-row';

        (q.choices || []).forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c.text;
          btn.className = 'flex-1 px-4 py-3 rounded-2xl border border-purple-100 bg-white text-left whitespace-normal leading-relaxed shadow-sm hover:shadow-md transition';

          btn.onclick = () => {
            [...choices.children].forEach(b => {
              b.classList.remove('bg-gradient-to-r','from-pink-500','to-purple-500','text-white','border-transparent','shadow-lg');
            });
            btn.classList.add('bg-gradient-to-r','from-pink-500','to-purple-500','text-white','border-transparent','shadow-lg');
            form.dataset[q.qId] = idx; // 0 or 1
            updateProgress(questions);
          };

          choices.appendChild(btn);
        });

        box.appendChild(title);
        box.appendChild(choices);
        form.appendChild(box);
      });
    }

    async function submitAnswers(questions){
      const form = document.getElementById('form');
      const answers = {};

      for(const q of questions){
        const v = form.dataset[q.qId];
        if(v === undefined){
          alert(`æœªå›ç­”ã®è³ªå•ãŒã‚ã‚Šã¾ã™ï¼ˆQ${q.order}ï¼‰`);
          throw new Error('æœªå›ç­”');
        }
        answers[q.qId] = Number(v);
      }

      const payload = {
        path: 'submit',
        diagnosisId: 'A',
        sessionId: sid(),
        answers,
        email: '',
        ua: navigator.userAgent
      };

      const r = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'è¨ºæ–­ã«å¤±æ•—ã—ã¾ã—ãŸ');

      sessionStorage.setItem('LAST_RESULT_JSON', JSON.stringify(j));
      location.href = './result.html?diagnosisId=A';
    }

    (async function main(){
      try{
        const questions = await loadQuestions();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('form').classList.remove('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');

        renderQuestions(questions);

        document.getElementById('submitBtn').onclick = async () => {
          const btn = document.getElementById('submitBtn');
          btn.textContent = 'è¨ºæ–­ä¸­â€¦';
          btn.disabled = true;
          await submitAnswers(questions);
        };

      }catch(e){
        document.getElementById('loading').textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + e.message;
      }
    })();
  </script>
</body>
</html>
