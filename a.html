<div class="text-xs text-gray-400">a.html version: 2026-01-28-1</div>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>診断A｜看護師管理者向け16パーソナリティ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ★必ず head 内で config.js を読み込む -->
  <script src="./config.js"></script>
</head>

<body class="bg-[#f6e9ee] text-slate-800 min-h-screen">
  <div class="relative">
    <div class="max-w-3xl mx-auto p-6">

      <!-- トップバー（左上ピルは削除。右のトップへだけ残す） -->
      <div class="mb-5">
        <div class="flex items-center justify-end text-sm text-slate-500">
          <a href="./index.html" class="font-semibold text-slate-500 hover:text-slate-700">トップへ</a>
        </div>
      </div>

      <!-- 進捗（固定表示：説明文なし / バー + 0/20のみ） -->
      <div id="progressWrap" class="sticky top-0 z-20 -mx-6 px-6 pt-3 pb-3 bg-[#f6e9ee]/90 backdrop-blur border-b border-rose-100">
        <div class="flex items-center justify-between">
          <div class="h-2 w-full rounded-full bg-rose-100/80 overflow-hidden">
            <div id="progressBar" class="h-2 rounded-full bg-[#e7a9bc]" style="width:0%"></div>
          </div>
          <div id="progressText" class="ml-3 shrink-0 text-sm font-semibold text-slate-700 tabular-nums">0 / 0</div>
        </div>
      </div>

     <!-- タイトル＋説明（半分囲い：上＋左右のみ / 下は開ける） -->
      <div class="mt-6 mb-7">
        <div class="relative">
          <!-- 半分囲いカード -->
          <div class="rounded-3xl bg-white/75 shadow-sm px-6 py-7
                      border border-rose-200/70 border-b-0">
            <h1 class="text-center leading-tight">
              <!-- 1行目（同色） -->
              <div class="text-4xl sm:text-5xl font-extrabold tracking-tight text-slate-800">
                看護師タイプ診断～
              </div>
              <!-- 2行目（同色・少し小さめ） -->
              <div class="mt-1 text-2xl sm:text-3xl font-extrabold tracking-tight text-slate-800">
                病院を支える管理職向け～
              </div>
            </h1>
      
            <!-- タイトルと説明文はスペースを空ける -->
            <p class="text-base sm:text-lg text-slate-600 mt-5 text-center">
              あなたの現場とのかかわり方を見える化。
            </p>
          </div>
      
          <!-- 下側の“開き”をかわいく（開いているのに途切れて見えない工夫） -->
          <div class="h-4"></div>
          <div class="mx-6 -mt-2 h-1 rounded-full bg-rose-200/70"></div>
      
          <!-- ほんのり楽しい装飾（任意：残してOK） -->
          <div class="mt-5 flex justify-center">
            <div class="h-2 w-24 rounded-full bg-gradient-to-r from-rose-200 via-pink-200 to-rose-100"></div>
          </div>
        </div>
      </div>

      <div id="loading" class="text-slate-600">質問を読み込んでいます…</div>

      <form id="form" class="hidden space-y-6"></form>

      <div class="mt-8">
        <button id="submitBtn"
          class="hidden w-full px-4 py-4 rounded-2xl bg-[#eaa5bb] text-white text-lg font-semibold shadow-sm transition
                 hover:bg-[#e38fac] disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-[#eaa5bb]">
          診断する
        </button>
        <p class="mt-3 text-center text-xs text-slate-500">診断結果はすぐに表示されます。</p>
      </div>
    </div>
  </div>

  <script>
    function GAS_URL(){
      const u = window.APP_CONFIG && window.APP_CONFIG.GAS_URL;
      if(!u) throw new Error('APP_CONFIG.GAS_URL が見つかりません（config.js を確認してください）');
      return u;
    }

    function sid(){
      const k = 'diag_sid';
      let v = localStorage.getItem(k);
      if(!v){
        v = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
        localStorage.setItem(k, v);
      }
      return v;
    }

    async function loadQuestions(){
      const url = `${GAS_URL()}?path=questions&diagnosisId=A`;
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || '質問取得に失敗しました');
      return j.questions;
    }

    function setSubmitEnabled(questions){
      const form = document.getElementById('form');
      const btn = document.getElementById('submitBtn');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const allAnswered = (total > 0 && answered === total);

      btn.disabled = !allAnswered;
      // 「全回答まで薄い」＋ hoverも抑制（disabledクラスで対応済み）
    }

    function updateProgress(questions){
      const form = document.getElementById('form');
      const total = questions.length;
      const answered = Object.keys(form.dataset || {}).length;
      const ratio = total ? Math.round((answered / total) * 100) : 0;

      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');

      if(progressText) progressText.textContent = `${answered} / ${total}`;
      if(progressBar) progressBar.style.width = `${ratio}%`;

      setSubmitEnabled(questions);
    }

    function renderQuestions(questions){
      const form = document.getElementById('form');
      form.innerHTML = '';
      updateProgress(questions);

      questions.forEach(q => {
        const box = document.createElement('div');
        box.className = 'py-6 border-b border-rose-100/80';

        const title = document.createElement('div');
        // 質問：少し大きく＋中央より
        title.className = 'font-semibold mb-4 text-slate-800 text-xl sm:text-2xl text-center';
        title.textContent = `Q${q.order}. ${q.questionText}`;

        const choices = document.createElement('div');
        choices.className = 'flex gap-3 flex-col sm:flex-row';

        (q.choices || []).forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c.text;

          // 回答ボタン：ピンク系、文字は中央寄り＆少し大きく
          btn.className =
            'flex-1 px-4 py-3 rounded-2xl border border-rose-200/80 bg-white/80 ' +
            'text-center whitespace-normal leading-relaxed text-base sm:text-lg text-slate-800 shadow-sm ' +
            'hover:border-rose-300 hover:bg-rose-50 transition';

          btn.onclick = () => {
            [...choices.children].forEach(b => {
              b.classList.remove('bg-[#e38fac]','text-white','border-transparent','shadow-md');
              b.classList.add('bg-white/80','text-slate-800');
            });

            btn.classList.remove('bg-white/80','text-slate-800');
            btn.classList.add('bg-[#e38fac]','text-white','border-transparent','shadow-md');

            form.dataset[q.qId] = idx; // 0 or 1
            updateProgress(questions);
          };

          choices.appendChild(btn);
        });

        box.appendChild(title);
        box.appendChild(choices);
        form.appendChild(box);
      });
    }

    async function submitAnswers(questions){
      const form = document.getElementById('form');
      const answers = {};

      for(const q of questions){
        const v = form.dataset[q.qId];
        if(v === undefined){
          alert(`未回答の質問があります（Q${q.order}）`);
          throw new Error('未回答');
        }
        answers[q.qId] = Number(v);
      }

      const payload = {
        path: 'submit',
        diagnosisId: 'A',
        sessionId: sid(),
        answers,
        email: '',
        ua: navigator.userAgent
      };

      const r = await fetch(GAS_URL(), {
        method: 'POST',
        headers: { 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      const j = await r.json();
      if(!j.ok) throw new Error(j.error || '診断に失敗しました');

      sessionStorage.setItem('LAST_RESULT_JSON', JSON.stringify(j));
      location.href = './result.html?diagnosisId=A';
    }

    (async function main(){
      try{
        const questions = await loadQuestions();

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('form').classList.remove('hidden');
        document.getElementById('submitBtn').classList.remove('hidden');

        renderQuestions(questions);

        const submitBtn = document.getElementById('submitBtn');
        // 初期は薄い（disabled）にしたいので、ここで必ず反映
        submitBtn.disabled = true;
        setSubmitEnabled(questions);

        submitBtn.onclick = async () => {
          if(submitBtn.disabled) return; // 全回答前は押せない
          submitBtn.textContent = '診断中…';
          submitBtn.disabled = true;
          await submitAnswers(questions);
        };

      }catch(e){
        document.getElementById('loading').textContent = 'エラー：' + e.message;
      }
    })();
  </script>
</body>
</html>
